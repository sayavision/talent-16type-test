<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>能力の輪｜診断結果</title>
  <style>
    :root{ --bg:#0b1020; --card:#111a33; --txt:#e9ecf4; --muted:#a9b2cc; --line:rgba(255,255,255,.10); --accent:#7aa2ff; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      background: linear-gradient(180deg,#0b1020,#070a12); color:var(--txt); }
    .wrap{ max-width:980px; margin:0 auto; padding:24px; }
    .card{ background: rgba(17,26,51,.92); border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px; padding: 18px; box-shadow: 0 12px 30px rgba(0,0,0,.25); }
    .row{ display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
    .col{ flex:1; min-width:280px; }
    h1{ font-size:20px; margin:0 0 8px; }
    h2{ font-size:18px; margin:0 0 10px; }
    h3{ font-size:15px; margin:14px 0 8px; }
    p{ margin:8px 0; color:var(--muted); line-height:1.7; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--muted); font-size:12px; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }
    .resultTop{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .resultTop img{ width:190px; max-width:42vw; height:auto; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); }
    .bars{ display:grid; gap:10px; margin-top:10px; }
    .barRow{ display:grid; grid-template-columns: 120px 1fr 64px; gap:10px; align-items:center; }
    .barLabel{ color:var(--muted); font-size:13px; }
    .barTrack{ height:12px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.10); }
    .barFill{ height:100%; width:0%; background: var(--accent); }
    .barVal{ color:var(--muted); font-size:13px; text-align:right; }
    .rankTable{ width:100%; border-collapse:collapse; margin-top:10px; }
    .rankTable th,.rankTable td{ border-bottom:1px solid rgba(255,255,255,.10); padding:10px 6px; vertical-align:top; }
    .rankTable th{ color:var(--muted); font-weight:600; font-size:12px; text-align:left; }
    .rankNum{ width:42px; color:var(--muted); }
    .rankPct{ width:72px; text-align:right; color:var(--muted); }
    .box{ border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; background: rgba(255,255,255,.03); }
    .btn{ background: var(--accent); color:#07102a; border:0; padding:10px 14px; border-radius: 12px; font-weight: 800; cursor:pointer; }
    .btn.sub{ background: transparent; color: var(--txt); border: 1px solid rgba(255,255,255,.14); }
    input{ width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); color: var(--txt); }
    label{ display:block; margin:10px 0 6px; color:var(--muted); font-size:12px; }
    .small{ font-size:12px; color:var(--muted); }
    .warn{ color:#ffcf7a; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>能力の輪｜診断結果</h1>
    <div class="row">
      <button class="btn sub" id="btnBackToQuiz">質問ページに戻る</button>
      <button class="btn sub" id="btnReset">結果リセット</button>
    </div>
  </div>

  <div style="height:14px"></div>

  <div class="card" id="resultCard">
    <h2>メインフィールド</h2>
    <div class="resultTop">
      <img id="fieldImg" src="" alt="main field image">
      <div>
        <div class="pill" id="fieldPill">MAIN FIELD</div>
        <h1 id="fieldTitle" style="margin-top:10px;">-</h1>
        <p id="fieldShort" style="margin-top:8px;">-</p>
        <p class="small warn" id="noDataWarn" style="display:none;">まだ結果データがありません。先に質問ページで回答してね。</p>
      </div>
    </div>

    <div class="hr"></div>

    <h2>４フィールドのパーセンテージ</h2>
    <div class="bars" id="fieldBars"></div>

    <div class="hr"></div>

    <h2>あなたの才能ランキング（16すべて）</h2>
    <table class="rankTable" id="rankTable">
      <thead>
        <tr>
          <th class="rankNum">順位</th>
          <th>才能</th>
          <th>説明</th>
          <th class="rankPct">％</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="hr"></div>

    <h2>上位３つの才能（各フィードバック）</h2>
    <div class="row" id="top3Boxes"></div>

    <div class="hr"></div>

    <h2>上位３つの掛け合わせフィードバック</h2>
    <div class="box">
      <p id="combo800" style="white-space:pre-wrap; margin:0;"></p>
    </div>

    <div class="hr"></div>

    <h2>太陽星座×才能フィードバック</h2>
    <div class="row">
      <div class="col box">
        <h3>太陽星座（任意）</h3>
        <label>太陽星座 or 誕生日（例：Gemini / 双子座 / 1990/6/4）</label>
        <input id="sun" placeholder="Gemini / 双子座 / 1990/6/4">
        <div class="pill" id="sunResolved" style="margin-top:10px; display:none;"></div>
        <p class="small" id="sunMeaning" style="margin-top:8px;"></p>
        <button class="btn sub" id="btnRegenStar" style="margin-top:10px;">太陽×才能を再生成</button>
      </div>
      <div class="col box">
        <p id="star800" style="white-space:pre-wrap; margin:0;"></p>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <button class="btn" id="btnShare">結果をシェア（全文）</button>
      <button class="btn sub" id="btnCopy">結果をコピー</button>
    </div>
    <p class="small" id="shareHint"></p>
  </div>
</div>

<script>
/* ======= 表示用データ ======= */
const FIELD_IMAGE = { EARTH:"./element_earth.png", FIRE:"./element_fire.png", AIR:"./element_air.png", WATER:"./element_water.png" };
const FIELD_INFO = {
  EARTH:{ name:"EARTH｜形にするフィールド", short:"段取り・仕組み・継続で、未来を現実に着地させるタイプ。日々の積み上げで強くなる。" },
  FIRE:{  name:"FIRE｜動かすフィールド",   short:"熱量・発信・推進で、流れを生み出すタイプ。場を前に進める力がある。" },
  AIR:{   name:"AIR｜ひらめくフィールド", short:"分析・学習・言語化で、可能性を広げるタイプ。理解を深めて価値に変える。" },
  WATER:{ name:"WATER｜つなぐフィールド", short:"共感・調和・協働で、人と場を整えるタイプ。安心感が推進力になる。" },
};

/* ======= さやちゃんの学習：星座×資質（BEST3＋補足） =======
   ※資質名は日本語のまま保持（画面表示用）
*/
const SIGN_STRENGTHS = {
  Aries: { jp:"牡羊座", theme:"行動・スピード・突破力", best:[
    { name:"活発性", level:3, c:"行動の速さ・動きながら考える" },
    { name:"達成欲", level:3, c:"ゴールへまっすぐ走る" },
    { name:"指令性", level:3, c:"グイっと前に出てリードする" },
  ], sub:["競争性","自己確信","自我"] },
  Taurus:{ jp:"牡牛座", theme:"安定・継続・五感・粘り強さ", best:[
    { name:"慎重さ", level:3, c:"じっくり・丁寧・リスク管理" },
    { name:"規律性", level:3, c:"安定したペース・続ける才能" },
    { name:"責任感", level:2, c:"任されたことを守る" },
  ], sub:["回復志向","公平性","調和性"] },
  Gemini:{ jp:"双子座", theme:"情報・コミュニケーション・スピード思考", best:[
    { name:"コミュニケーション", level:3, c:"喋る・伝える才能" },
    { name:"社交性", level:3, c:"人とのつながりが才能" },
    { name:"着想", level:2, c:"アイデアの速さ" },
  ], sub:["活発性","学習欲","分析思考"] },
  Cancer:{ jp:"蟹座", theme:"共感・保護・感情・家族性", best:[
    { name:"共感性", level:3, c:"感情を読むのが天才的" },
    { name:"包含", level:3, c:"仲間として受け入れる" },
    { name:"親密性", level:2, c:"深い関わりを好む" },
  ], sub:["調和性","個別化","運命思考"] },
  Leo:{ jp:"獅子座", theme:"表現・存在感・創造性・自己実現", best:[
    { name:"自己確信", level:3, c:"自信・堂々とした表現" },
    { name:"活発性", level:2, c:"明るく外へ向かう力" },
    { name:"自我", level:2, c:"認められたい・称賛されたい" },
  ], sub:["コミュニケーション","未来志向","最上志向"] },
  Virgo:{ jp:"乙女座", theme:"分析・改善・実務的・細部の才能", best:[
    { name:"分析思考", level:3, c:"事実に基づき考える" },
    { name:"回復志向", level:3, c:"改善・修正の天才" },
    { name:"慎重さ", level:2, c:"リスク回避能力" },
  ], sub:["規律性","責任感","アレンジ"] },
  Libra:{ jp:"天秤座", theme:"調和・美・関係性・バランス", best:[
    { name:"適応性", level:3, c:"調整・しなやかさ" },
    { name:"調和性", level:3, c:"平和をつくる才能" },
    { name:"コミュニケーション", level:2, c:"言葉選びが上手" },
  ], sub:["分析思考","個別化"] },
  Scorpio:{ jp:"蠍座", theme:"深掘り・集中・変容・情熱の芯", best:[
    { name:"個別化", level:3, c:"一人を深く理解する" },
    { name:"内省", level:3, c:"深く掘り下げる" },
    { name:"戦略性", level:2, c:"裏側や本質を読む" },
  ], sub:["自己確信","共感性","アレンジ"] },
  Sagittarius:{ jp:"射手座", theme:"自由・探求・冒険・哲学", best:[
    { name:"未来志向", level:3, c:"理想を語る力" },
    { name:"着想", level:3, c:"アイデアの広がり" },
    { name:"学習欲", level:2, c:"探求心が強い" },
  ], sub:["活発性","信念"] },
  Capricorn:{ jp:"山羊座", theme:"実現・構築・結果主義・責任感", best:[
    { name:"達成欲", level:3, c:"ゴールをつかむ力" },
    { name:"責任感", level:3, c:"約束を守る・任される" },
    { name:"規律性", level:3, c:"計画を守る" },
  ], sub:["戦略性","自我"] },
  Aquarius:{ jp:"水瓶座", theme:"革新・個性・未来・客観性", best:[
    { name:"着想", level:3, c:"独創的アイデア" },
    { name:"未来志向", level:3, c:"未来のビジョンを描く" },
    { name:"分析思考", level:2, c:"客観・ロジック" },
  ], sub:["学習欲","適応性"] },
  Pisces:{ jp:"魚座", theme:"癒し・直感・共感・境界が溶ける", best:[
    { name:"共感性", level:3, c:"感情の深い共鳴" },
    { name:"適応性", level:3, c:"ふわっと馴染む" },
    { name:"運命思考", level:2, c:"“流れ”を感じる" },
  ], sub:["収集心","個別化"] },
};

/* ======= 星座入力の別名対応 ======= */
const SIGN_ALIAS = {
  "おひつじ座":"Aries","牡羊座":"Aries","aries":"Aries",
  "おうし座":"Taurus","牡牛座":"Taurus","taurus":"Taurus",
  "ふたご座":"Gemini","双子座":"Gemini","gemini":"Gemini",
  "かに座":"Cancer","蟹座":"Cancer","cancer":"Cancer",
  "しし座":"Leo","獅子座":"Leo","leo":"Leo",
  "おとめ座":"Virgo","乙女座":"Virgo","virgo":"Virgo",
  "てんびん座":"Libra","天秤座":"Libra","libra":"Libra",
  "さそり座":"Scorpio","蠍座":"Scorpio","scorpio":"Scorpio",
  "いて座":"Sagittarius","射手座":"Sagittarius","sagittarius":"Sagittarius",
  "やぎ座":"Capricorn","山羊座":"Capricorn","capricorn":"Capricorn",
  "みずがめ座":"Aquarius","水瓶座":"Aquarius","aquarius":"Aquarius",
  "うお座":"Pisces","魚座":"Pisces","pisces":"Pisces"
};

/* ======= 資質→16才能（接続辞書） =======
   ここが精度アップの肝。星座BEST資質から、相性の良い“才能語”を文章に混ぜる。
*/
const STRENGTH_TO_TALENTS = {
  "学習欲":["学習探究","アイディア","本質"],
  "分析思考":["本質","整理整頓","仕組み"],
  "着想":["アイディア","ビジョン","表現"],
  "未来志向":["ビジョン","求心","先導"],
  "コミュニケーション":["表現","開放","求心"],
  "社交性":["求心","開放","先導"],
  "活発性":["先導","開放","目標達成"],
  "達成欲":["目標達成","仕組み","整理整頓"],
  "指令性":["先導","求心","目標達成"],
  "規律性":["仕組み","整理整頓","目標達成"],
  "慎重さ":["整理整頓","本質","修復"],
  "責任感":["目標達成","バランス","育成"],
  "回復志向":["修復","仕組み","本質"],
  "共感性":["寄り添い","調和","育成"],
  "包含":["調和","バランス","育成"],
  "親密性":["寄り添い","育成","調和"],
  "適応性":["バランス","調和","開放"],
  "調和性":["調和","バランス","寄り添い"],
  "個別化":["寄り添い","育成","本質"],
  "内省":["本質","ビジョン","学習探究"],
  "戦略性":["ビジョン","本質","仕組み"],
  "運命思考":["寄り添い","ビジョン","調和"],
  "自我":["表現","先導","求心"],
  "自己確信":["先導","表現","ビジョン"],
  "信念":["ビジョン","目標達成","本質"],
  "収集心":["学習探究","アイディア","本質"],
  "競争性":["目標達成","先導","求心"],
  "公平性":["バランス","調和","仕組み"],
  "アレンジ":["仕組み","バランス","修復"],
};

/* ======= テキストの字数調整 ======= */
function fitToRange(text, minLen, maxLen){
  let s = (text || "").trim();
  const pad = "。あなたの強みは、使うほど現実で洗練されます。小さく試して、反応を見て、磨き直す。この循環が才能を最短で育てます";
  while (s.length < minLen) s += pad.slice(0, Math.min(pad.length, minLen - s.length));
  if (s.length > maxLen) s = s.slice(0, maxLen);
  return s;
}

/* ======= 太陽星座の自動判定（誕生日対応） ======= */
function parseDateLike(str){
  const s = (str || "").trim();
  if (!s) return null;
  let m = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
  if (m) return { y:+m[1], mo:+m[2], d:+m[3] };
  m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})$/);
  if (m) return { y:null, mo:+m[1], d:+m[2] };
  m = s.match(/^(\d{4})年(\d{1,2})月(\d{1,2})日$/);
  if (m) return { y:+m[1], mo:+m[2], d:+m[3] };
  return null;
}
function zodiacByMonthDay(mo, d){
  if ((mo===3 && d>=21) || (mo===4 && d<=19)) return "Aries";
  if ((mo===4 && d>=20) || (mo===5 && d<=20)) return "Taurus";
  if ((mo===5 && d>=21) || (mo===6 && d<=20)) return "Gemini";
  if ((mo===6 && d>=21) || (mo===7 && d<=22)) return "Cancer";
  if ((mo===7 && d>=23) || (mo===8 && d<=22)) return "Leo";
  if ((mo===8 && d>=23) || (mo===9 && d<=22)) return "Virgo";
  if ((mo===9 && d>=23) || (mo===10 && d<=22)) return "Libra";
  if ((mo===10 && d>=23) || (mo===11 && d<=21)) return "Scorpio";
  if ((mo===11 && d>=22) || (mo===12 && d<=21)) return "Sagittarius";
  if ((mo===12 && d>=22) || (mo===1 && d<=19)) return "Capricorn";
  if ((mo===1 && d>=20) || (mo===2 && d<=18)) return "Aquarius";
  if ((mo===2 && d>=19) || (mo===3 && d<=20)) return "Pisces";
  return null;
}
function resolveSun(input){
  const raw = (input || "").trim();
  if (!raw) return { raw, key:null, label:"未入力", meaning:"" };

  const lower = raw.toLowerCase().replace(/\s/g,"");
  const aliasKey = SIGN_ALIAS[raw] || SIGN_ALIAS[lower];
  if (aliasKey && SIGN_STRENGTHS[aliasKey]){
    const s = SIGN_STRENGTHS[aliasKey];
    return { raw, key:aliasKey, label:`${aliasKey}（${s.jp}）`, meaning:`テーマ：${s.theme}` };
  }
  if (SIGN_STRENGTHS[raw]){
    const s = SIGN_STRENGTHS[raw];
    return { raw, key:raw, label:`${raw}（${s.jp}）`, meaning:`テーマ：${s.theme}` };
  }

  const dt = parseDateLike(raw);
  if (dt && dt.mo && dt.d){
    const key = zodiacByMonthDay(dt.mo, dt.d);
    if (key && SIGN_STRENGTHS[key]){
      const s = SIGN_STRENGTHS[key];
      return { raw, key, label:`${key}（${s.jp}）`, meaning:`テーマ：${s.theme}` };
    }
  }
  return { raw, key:null, label:`入力：${raw}`, meaning:"※星座名（Gemini/双子座など）か、誕生日（1990/6/4など）で入力すると自動判定できます。" };
}

/* ======= 結果取得 ======= */
function getResult(){
  const raw = localStorage.getItem("talentResult");
  if (!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}
function clampPercent(n){
  n = Number(n);
  if (!Number.isFinite(n)) return 0;
  return Math.max(0, Math.min(100, Math.round(n)));
}

/* ======= 上位3 才能フィードバック（具体化＋字数レンジ固定） ======= */
function topTalentFeedback(t, fieldName, sunPack){
  const name = t.name, pct = t.pct;
  const sunHint = (sunPack?.key && SIGN_STRENGTHS[sunPack.key])
    ? `太陽${SIGN_STRENGTHS[sunPack.key].jp}の流れだと「${SIGN_STRENGTHS[sunPack.key].best[0].name}」の使い方が追い風になります。`
    : "";

  const lib = {
    "学習探究": `「学習探究」は、気になったテーマを深掘りして“使える知識”に変換する才能です。あなたは情報を集めるだけでなく、要点を抜き出して整理し、自分の言葉に直すことで理解が一段深まります。メインが${fieldName}なら、学びを行動や仕組みに落とすほど成果が早いはず。おすすめは「学ぶ→1枚にまとめる→小さく試す」の3点セット。注意点は、学びが増えるほど着手が遅れること。期限を切って“まず出す”を習慣にすると伸びます。${sunHint}`,
    "アイディア": `「アイディア」は、点在する経験や知識をつなげて新しい企画・切り口を生む才能です。あなたは“別分野の共通点”を見つけるのが得意で、既存の正解をなぞるより独自の編集で価値を出せます。メインが${fieldName}なら、ひらめきを「型」に落とすほど強みが安定。おすすめは「メモ→3案に絞る→1つだけ実装」。注意点はアイデアが増えすぎて散らかること。今月のテーマを1つ決めると爆発力が上がります。${sunHint}`,
    "仕組み": `「仕組み」は、再現性を作って“勝手に回る状態”へ整える才能です。あなたは属人的な作業を分解し、ルール化・テンプレ化・導線化して、無駄な消耗を減らせます。メインが${fieldName}なら、整えた仕組みがそのまま成果に直結しやすいはず。おすすめは「チェックリスト化→週1で改善→手放す」。注意点は完璧に作ってから出したくなること。まず仮で運用し、反応で育てると最速で洗練されます。${sunHint}`,
    "本質": `「本質」は、情報のノイズを削ぎ落として核心にたどり着く才能です。あなたは“結局いちばん大事なポイント”を掴むのが上手で、迷いが多い場面ほど価値が出ます。メインが${fieldName}なら、見抜いた本質を行動指針に落とすほど強みが安定。おすすめは「結論→理由→具体例」で伝えること。注意点は正しさが強く出ると相手が置いていかれること。相手の理解速度に合わせると説得力が伸びます。${sunHint}`,
    "整理整頓": `「整理整頓」は、混沌を分類して“使いやすい形”に整える才能です。情報・物・タスクを、行動しやすい状態へ変換できます。メインが${fieldName}なら、整えた瞬間に動きが速くなるはず。おすすめは「カテゴリ分け→優先順位→次の一手」まで決めること。注意点は整えること自体が目的になること。整理のゴールを“実行が早くなる”に置くと、あなたの価値が最大化します。${sunHint}`,
    "ビジョン": `「ビジョン」は、価値観を軸に未来像を描き、方向性を言語化する才能です。あなたは理想を描くだけでなく、“なぜそれをやるのか”を自分の言葉で定義できるタイプ。メインが${fieldName}なら、ビジョンを予定表と行動に落とすほど加速します。おすすめは「3ヶ月の到達点→今週の一歩」へ分解。注意点は理想が大きいほど動けなくなること。最小の実装を決めると流れが戻ります。${sunHint}`,
    "寄り添い": `「寄り添い」は、相手の感情の深いところを感じ取り、その人のペースで支える才能です。あなたの安心感は、相手の自己開示を引き出し、本音から前進を生みます。メインが${fieldName}なら、寄り添いを“次の一歩”に繋げるほど成果が安定。おすすめは「共感→整理→提案」の順。注意点は抱え込みすぎること。境界線を引くほど、あなたの優しさが長く機能します。${sunHint}`,
    "調和": `「調和」は、人と人の摩擦を和らげ、安心・安全な空気をつくる才能です。あなたがいると場が整い、対立が“合意”へ変わりやすい。メインが${fieldName}なら、関係性を整えつつ前に進める力が強みになります。おすすめは「共通目的」を言葉にすること。注意点は本音を飲み込みすぎること。穏やかに“結論だけ”伝えると、調和と推進が両立します。${sunHint}`,
    "育成": `「育成」は、小さな成長の芽を見つけ、信じて伴走し続ける才能です。あなたは変化の兆しに敏感で、相手が続けられる形を一緒に作れます。メインが${fieldName}なら、育成を“仕組み”と組み合わせるほど伸びます。おすすめは「できたことログ」を作ること。注意点は相手の課題を自分の責任にしすぎること。主役は相手、あなたは伴走者の立ち位置が最強です。${sunHint}`,
    "バランス": `「バランス」は、全体を見ながら負担や役割の偏りを整える才能です。あなたは空気・人・進捗を同時に見て、“回る状態”へ戻す力があります。メインが${fieldName}なら、調整がそのまま成果の安定につながります。おすすめは「見える化→分担→期限」の3点。注意点は調整役を抱えすぎること。任せる範囲を増やすほど、あなたの影響力は強くなります。${sunHint}`,
    "目標達成": `「目標達成」は、決めたゴールへ粘り強く進み、達成まで持っていく才能です。あなたは“やると決めたら進む”推進力があり、途中でぶれても戻ってこられます。メインが${fieldName}なら、成果を積み上げる強さが出やすい。おすすめは「今週の3タスク」に落とすこと。注意点は頑張りすぎ。休む日も予定に入れると、達成が長期で安定します。${sunHint}`,
    "修復": `「修復」は、うまくいかない状態を立て直し、もう一度動く形に整える才能です。あなたは原因を分解し、何を直せば再始動できるかが見抜けます。メインが${fieldName}なら、修復が“仕組み化”に直結しやすい。おすすめは「原因→手当→再発防止」までセットで作ること。注意点は直しすぎて手放せないこと。直す対象と卒業する対象を分けると加速します。${sunHint}`,
    "開放": `「開放」は、場の空気をふわっと明るくし、人の心をオープンにする才能です。あなたの一言や雰囲気が、緊張をほどき本音を出しやすくします。メインが${fieldName}なら、開放が“関係性の推進力”になります。おすすめは小さなユーモアと肯定の相槌。注意点は明るさで論点が流れること。要所だけ締めると、魅力と成果が両立します。${sunHint}`,
    "表現": `「表現」は、内側を言葉や表情で届け、共感や納得を生む才能です。あなたは体験をストーリーに変え、相手が自分ごと化できる形で伝えられます。メインが${fieldName}なら、表現を“型”にするほど強みが安定。おすすめは「体験→気づき→次の一歩」でまとめること。注意点は出しすぎて疲れること。見せる範囲を選ぶほど、言葉の価値が上がります。${sunHint}`,
    "求心": `「求心」は「この指とまれ」で人を自然と集め、仲間を増やす才能です。あなたはテーマを掲げると人が集まり、輪ができやすい。メインが${fieldName}なら、集めた後に“回る形”を作ると強いです。おすすめは「旗（テーマ）→参加の一歩→継続の仕組み」。注意点は運営が重くなること。仕組みと分担を前提にすると、求心が長く機能します。${sunHint}`,
    "先導": `「先導」は半歩先に立って「こっちへ行こう」と道を示す才能です。あなたは迷いがある場面ほど、方向性を言語化して前に進められます。メインが${fieldName}なら、先導力が成果に直結しやすい。おすすめは「結論→理由→最初の一歩」を短く提示すること。注意点は速さが強く出ると置いていくこと。納得を拾うほど、自然なリーダーになります。${sunHint}`,
  };

  const raw = lib[name] || `「${name}」は${pct}%の才能です。あなたらしさが強く出る領域なので、日常の選択に積極的に使うほど伸びます。得意を“型”に落とすことで成果が安定し、周囲の評価も上がりやすいでしょう。`;
  // 220〜280字に揃える
  return fitToRange(raw, 220, 280);
}

/* ======= 3つ掛け合わせ（星座資質も混ぜる） ======= */
function buildCombo800(top3, fieldName, sunPack){
  const [a,b,c] = top3;
  const base =
`上位3才能は「${a.name}」「${b.name}」「${c.name}」。この組み合わせは、“見つける→組み立てる→回す”の流れを持っています。まず${a.name}で核となる価値や強みを掴み、${b.name}で形にするアイデアや構造を作り、${c.name}で再現性のある運用へ落とします。メインフィールドが${fieldName}の場合、この流れが現実に着地しやすく、積み上げが強みになります。

活かし方のコツは、ひらめきや学びが出たら“最小の実装”を即決すること。投稿1本・チェックリスト1枚・ミニ企画1つのように小さく形にして反応を見て改良する。あなたの強みは「一度作ったら終わり」ではなく「運用しながら磨く」で伸びます。

落とし穴は、準備や改善に熱中して“出す”が遅れること。週のどこかで「公開・提出・リリースの日」を固定し、完璧より回転数を優先すると、才能が一気に現実を動かします。最後に、あなたが一番気持ちよく伸びるのは“自分の美学”に沿っている時。違和感が出たら、核（${a.name}）に戻り、次の一手を小さく切り直すと流れが戻ります。`;

  let extra = "";
  if (sunPack?.key && SIGN_STRENGTHS[sunPack.key]){
    const s = SIGN_STRENGTHS[sunPack.key];
    const best = s.best.map(x=>x.name).join("・");
    extra =
`太陽星座は${s.jp}。この星座は資質で言うと「${best}」が濃いので、上位才能の使い方も“その資質のノリ”に合わせると伸びが速いです。`;
  }

  return fitToRange(base + "\n\n" + extra, 760, 860);
}

/* ======= 太陽×才能（星座資質→才能の橋渡し） ======= */
function buildStar800(top3, fieldName, sunPack, ranked){
  const sunKey = sunPack?.key;
  const sign = sunKey && SIGN_STRENGTHS[sunKey] ? SIGN_STRENGTHS[sunKey] : null;

  const topNames = top3.map(t=>t.name).join("・");
  let strengthsLine = "未入力の場合は空欄でOK。入力すると星座の傾向を反映できます。";
  let bridgeTalents = [];
  if (sign){
    const best = sign.best.map(x=>x.name);
    strengthsLine = `太陽星座は${sign.jp}（${sign.theme}）。資質で言うと「${best.join("・")}」が強く出やすいタイプです。`;
    // BEST資質→才能へ接続（重複排除）
    const cand = [];
    best.forEach(st=>{
      (STRENGTH_TO_TALENTS[st] || []).forEach(t=>cand.push(t));
    });
    bridgeTalents = [...new Set(cand)];
  }

  const pick = (arr, n)=> arr.slice(0, n);
  const bridgeText = bridgeTalents.length
    ? `星座の資質から見ると、あなたの才能では「${pick(bridgeTalents,3).join("・")}」が特に伸びやすい領域。上位3（${topNames}）と噛み合わせると、自然に成果へ繋がります。`
    : `星座が未確定でも、上位3（${topNames}）はあなたの核。これを日常の選択に使うほど結果が出やすいです。`;

  // “星座×上位3”の具体的な使い方を、上位3の役割に落とす
  const [a,b,c] = top3;
  const actionBlock =
`具体的には、①${a.name}を「やらないこと」まで含めて定義し、あなたの基準をはっきりさせます。②${b.name}で、基準を満たす形（企画・導線・言語）を3案出し、1つだけ実装に落とします。③${c.name}で、実装したものを“回る形”に整えます（テンプレ化・チェックリスト化・導線化）。メインが${fieldName}なら、ここまでやると成果が安定しやすいです。`;

  // 注意点：星座傾向に合わせて変える
  let caution = "注意点は、準備や改善に熱中して実装が遅れること。期限を切り、まず出してから磨く方が伸びます。";
  if (sunKey === "Aries") caution = "注意点は、勢いで走りすぎて整える前に疲れること。止まる日と整える日を予定に入れると最強です。";
  if (sunKey === "Taurus" || sunKey === "Capricorn") caution = "注意点は、堅実さが強く出て新しい挑戦が遅れること。小さく試す枠を作ると伸びが加速します。";
  if (sunKey === "Gemini") caution = "注意点は、面白い情報が増えすぎて散らかること。今月のテーマを1つに絞ると鋭さが出ます。";
  if (sunKey === "Cancer" || sunKey === "Pisces") caution = "注意点は、周りを優先して自分の軸が薄くなること。上位才能の核に戻る時間を確保すると安定します。";
  if (sunKey === "Virgo") caution = "注意点は、改善が止まらず公開が遅れること。仮で出して運用しながら直すと最速で洗練されます。";
  if (sunKey === "Aquarius") caution = "注意点は、独自性が先行して伝わりにくくなること。結論→例→一歩の順で言語化すると届きます。";
  if (sunKey === "Leo") caution = "注意点は、見せ方にエネルギーが偏って疲れること。目的（誰に何を届けるか）を先に固定すると強いです。";
  if (sunKey === "Libra") caution = "注意点は、調整に回りすぎて決断が遅れること。決める軸を1つ持つと前に進みます。";
  if (sunKey === "Scorpio") caution = "注意点は、深くやりすぎて時間が溶けること。期限を決めて“まず形にする”を入れると強いです。";
  if (sunKey === "Sagittarius") caution = "注意点は、広げすぎて散漫になること。今期の旗を1つに絞ると爆発力が出ます。";

  const txt =
`太陽星座×才能で見ると、「どの才能を、どのテンションで使うと伸びるか」が見えてきます。
${strengthsLine}
あなたの上位3才能は「${topNames}」。${bridgeText}

${actionBlock}

最後に、この診断結果は“性格の固定”ではなく“伸び方の設計図”です。${caution}
迷った時は「核（上位3）に戻る→最小の一歩を出す」。この循環が一番早くあなたの現実を動かします。`;

  return fitToRange(txt, 760, 860);
}

/* ======= DOM ======= */
const els = {
  fieldImg: document.getElementById("fieldImg"),
  fieldPill: document.getElementById("fieldPill"),
  fieldTitle: document.getElementById("fieldTitle"),
  fieldShort: document.getElementById("fieldShort"),
  noDataWarn: document.getElementById("noDataWarn"),
  fieldBars: document.getElementById("fieldBars"),
  rankBody: document.querySelector("#rankTable tbody"),
  top3Boxes: document.getElementById("top3Boxes"),
  combo800: document.getElementById("combo800"),
  sun: document.getElementById("sun"),
  sunResolved: document.getElementById("sunResolved"),
  sunMeaning: document.getElementById("sunMeaning"),
  star800: document.getElementById("star800"),
  shareHint: document.getElementById("shareHint"),
};

function render(){
  const r = getResult();
  if (!r){ els.noDataWarn.style.display="block"; return; }
  els.noDataWarn.style.display="none";

  const info = FIELD_INFO[r.mainField] || { name:r.mainField, short:"-" };
  els.fieldPill.textContent = `MAIN FIELD：${r.mainField}`;
  els.fieldTitle.textContent = info.name;
  els.fieldShort.textContent = info.short;

  els.fieldImg.src = FIELD_IMAGE[r.mainField] || "";
  els.fieldImg.alt = r.mainField;

  // 4フィールドバー
  els.fieldBars.innerHTML = "";
  ["EARTH","FIRE","AIR","WATER"].forEach(k=>{
    const val = clampPercent(r.fields?.[k] ?? 0);
    const row = document.createElement("div");
    row.className = "barRow";
    row.innerHTML = `
      <div class="barLabel">${(FIELD_INFO[k]?.name||k).split("｜")[0]}</div>
      <div class="barTrack"><div class="barFill" style="width:${val}%"></div></div>
      <div class="barVal">${val}%</div>
    `;
    els.fieldBars.appendChild(row);
  });

  // 才能ランキング
  const ranked = [...(r.talents||[])].sort((a,b)=> (b.pct||0) - (a.pct||0));
  els.rankBody.innerHTML = "";
  ranked.forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rankNum">${i+1}</td>
      <td><b>${t.name}</b></td>
      <td>${t.desc||""}</td>
      <td class="rankPct">${t.pct}%</td>
    `;
    els.rankBody.appendChild(tr);
  });

  // 太陽入力：indexから持ってきた raw（誕生日でもOK）
  const storedRaw = r.horoscope?.sun || "";
  els.sun.value = storedRaw;

  // 太陽星座を確定表示（ここが「出てない」問題の対策）
  const sunPack = resolveSun(els.sun.value);
  if (sunPack.label){
    els.sunResolved.style.display = "inline-block";
    els.sunResolved.textContent = `太陽星座（推定）：${sunPack.label}`;
    els.sunMeaning.textContent = sunPack.meaning || "";
  }

  // 上位3（220〜280字）
  const top3 = ranked.slice(0,3);
  els.top3Boxes.innerHTML = "";
  top3.forEach(t=>{
    const text = topTalentFeedback(t, info.name, sunPack);
    const box = document.createElement("div");
    box.className = "col box";
    box.innerHTML = `<h3>${t.name}（${t.pct}%）</h3><p style="white-space:pre-wrap;margin:0;">${text}</p>`;
    els.top3Boxes.appendChild(box);
  });

  // 掛け合わせ
  els.combo800.textContent = buildCombo800(top3, info.name, sunPack);

  // 太陽×才能
  els.star800.textContent = buildStar800(top3, info.name, sunPack, ranked);

  // 共有用パック
  window.__PACK__ = { r, info, ranked, top3, sunPack };
}

/* ======= シェア ======= */
function buildShareText(){
  const p = window.__PACK__;
  if (!p) return "結果がありません。";
  const s = p.sunPack?.label ? `太陽星座：${p.sunPack.label}` : "";
  const lines = [];
  lines.push("【能力の輪｜才能診断 結果】");
  lines.push(`メインフィールド：${p.info.name}`);
  if (s) lines.push(s);
  lines.push("");
  lines.push("▼４フィールド");
  lines.push(`EARTH ${p.r.fields.EARTH||0}% / FIRE ${p.r.fields.FIRE||0}% / AIR ${p.r.fields.AIR||0}% / WATER ${p.r.fields.WATER||0}%`);
  lines.push("");
  lines.push("▼上位3才能");
  p.top3.forEach((t,i)=> lines.push(`${i+1}. ${t.name} ${t.pct}%`));
  lines.push("");
  lines.push("URL：" + location.href);
  lines.push("#能力の輪プロジェクト #才能診断");
  return lines.join("\n");
}
async function share(){
  const text = buildShareText();
  els.shareHint.textContent = "";
  if (navigator.share){
    try{
      await navigator.share({ title:"能力の輪｜診断結果", text, url: location.href });
      els.shareHint.textContent = "共有しました！";
      return;
    }catch(e){}
  }
  await navigator.clipboard.writeText(text);
  els.shareHint.textContent = "コピーしました。SNS/LINEに貼り付けてシェアできます。";
}
async function copy(){
  await navigator.clipboard.writeText(buildShareText());
  els.shareHint.textContent = "コピーしました。";
}

/* ======= 再生成（太陽入力を保存→文章更新） ======= */
document.getElementById("btnRegenStar").addEventListener("click", ()=>{
  const p = window.__PACK__;
  if (!p) return;

  // 入力を保存（誕生日でもOK）
  p.r.horoscope = { sun: els.sun.value.trim() };
  localStorage.setItem("talentResult", JSON.stringify(p.r));

  // 再評価
  const sunPack = resolveSun(els.sun.value);
  p.sunPack = sunPack;

  els.sunResolved.style.display = "inline-block";
  els.sunResolved.textContent = `太陽星座（推定）：${sunPack.label}`;
  els.sunMeaning.textContent = sunPack.meaning || "";

  // 文章更新
  els.combo800.textContent = buildCombo800(p.top3, p.info.name, sunPack);
  els.star800.textContent = buildStar800(p.top3, p.info.name, sunPack, p.ranked);

  // 上位3も星座ヒントが入るので更新
  const boxes = document.querySelectorAll("#top3Boxes .col.box");
  boxes.forEach((box, i)=>{
    const t = p.top3[i];
    const newText = topTalentFeedback(t, p.info.name, sunPack);
    box.querySelector("p").textContent = newText;
  });

  els.shareHint.textContent = "太陽星座入力を保存して再生成しました。";
});

document.getElementById("btnBackToQuiz").addEventListener("click", ()=>{ location.href="./"; });
document.getElementById("btnReset").addEventListener("click", ()=>{ localStorage.removeItem("talentResult"); location.reload(); });
document.getElementById("btnShare").addEventListener("click", share);
document.getElementById("btnCopy").addEventListener("click", copy);

render();
</script>
</body>
</html>
